@page "/recipe/{recipe_id}"
@model SRSN.Client_View.Pages.Recipe_DetailModel
@{
    ViewData["Title"] = "Recipe_Detail";
}
<!--banner ends-->
@section StyleOptional{
    <link rel="stylesheet" href="/recipepress/css/plugins.min.css">

    <!-- ==== Main Stylesheet ==== -->
    <link rel="stylesheet" href="/recipepress/css/style.css">

    <!-- ==== Responsive Stylesheet ==== -->
    <link rel="stylesheet" href="/recipepress/css/responsive-style.css">

    <!-- ==== Color Scheme Stylesheet ==== -->
    <link rel="stylesheet" href="/recipepress/css/colors/color-1.css" id="changeColorScheme">

    <!-- ==== Custom Stylesheet ==== -->
    <link rel="stylesheet" href="/recipepress/css/custom.css">
}
    <div class="recipes-home-body inner-page">
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-lg-9">
                    <div class="recipe-set ">
                        <div class="wrapper-detail-contents detail-2">
                            <div class="single-recipe-detail" id="banner-recipe">
                            </div>
                            <div class="recipe-detail-body">
                                <div id="content-recipe">
                                    <!--Content-->
                                </div>
                                <br />
                                <div class="ingredients-checkbox">
                                    <div class="ingredients">
                                        <h3>Nguyên liệu</h3>

                                        <ul id="list-of-ingredients"></ul>
                                        <div class="col-md-12">
                                            <a id="btn-suggest-ingredients" class="default-btn mid-button theme-color pull-right">Cửa hàng gần nhất</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="recipe-steps">
                                    <h3 class="lined">Các bước thực hiện</h3>
                                    <dl class="accordion clearfix" id="list-step-recipe"></dl>
                                </div>
                                <div class="separator-post"></div>
                                <div class="tags-icons">
                                    <div class="row">
                                        <div class="col-sm-7">
                                            <div class="details-tags">
                                                <ul>
                                                    <li><a href="#">garlic</a></li>
                                                    <li><a href="#">pizza</a></li>
                                                    <li><a href="#">potato</a></li>
                                                    <li><a href="#">roasted</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-sm-5">
                                            <div class="details-social-icons">
                                                <a href="#/" title="Like" class="like-button">
                                                    <i class=" fa fa-2x fa-heart-o" onclick="toggleLikeButton(this)" id="like-heart"></i>
                                                </a>
                                                <a id="btn-share-recipe" title="Chia sẻ"><i class="fa fa-2x fa-share"></i></a>
                                                <a id="btn-add-collection" title="Thêm vào BST"><i class="fa fa-2x fa-plus"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="about-chef"></div>

                            <div class="related-recipes">
                                <h3 class="lined">Related Recipes</h3>
                                <div class="boxed-recipes text-center" id="list-related-recipe">

                                </div>
                            </div>

                            <div class="recipe-comments">
                                <h3 class="lined">Comments (<span id="numOfComment"></span>)</h3>
                                <ul id="list-rating-comment"></ul>
                            </div>

                            <div class="comment-form">
                                <h3 class="lined">Leave Comment</h3>

                                <div class="form-rating">
                                    <p class="alert green alert-success">Đăng đánh giá thành công!<span class="close-alert"><i class="fa fa-close"></i></span></p>
                                    <p class="alert red alert-comment"><span class="close-alert"><i class="fa fa-close"></i></span></p>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="col-md-3 rating-title">Đánh giá công thức</div>
                                            <div class="col-md-8">
                                                <fieldset class="rating-recipe">
                                                    <input type="radio" id="star5" name="rating" value="5" /><label class="full" for="star5" title="Awesome - 5 stars"></label>
                                                    <input type="radio" id="star4half" name="rating" value="4.5" /><label class="half" for="star4half" title="Pretty good - 4.5 stars"></label>
                                                    <input type="radio" id="star4" name="rating" value="4" /><label class="full" for="star4" title="Pretty good - 4 stars"></label>
                                                    <input type="radio" id="star3half" name="rating" value="3.5" /><label class="half" for="star3half" title="Meh - 3.5 stars"></label>
                                                    <input type="radio" id="star3" name="rating" value="3" /><label class="full" for="star3" title="Meh - 3 stars"></label>
                                                    <input type="radio" id="star2half" name="rating" value="2.5" /><label class="half" for="star2half" title="Kinda bad - 2.5 stars"></label>
                                                    <input type="radio" id="star2" name="rating" value="2" /><label class="full" for="star2" title="Kinda bad - 2 stars"></label>
                                                    <input type="radio" id="star1half" name="rating" value="1.5" /><label class="half" for="star1half" title="Meh - 1.5 stars"></label>
                                                    <input type="radio" id="star1" name="rating" value="1" /><label class="full" for="star1" title="Sucks big time - 1 star"></label>
                                                    <input type="radio" id="starhalf" name="rating" value="0.5" /><label class="half" for="starhalf" title="Sucks big time - 0.5 stars"></label>
                                                </fieldset>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <textarea name="comment" id="comment"
                                                      placeholder="Bình luận:
                                                  * Mẹo: Nội dung đánh giá phải mang tính chất khách quan, từ chia sẻ đánh giá của bạn sẽ giúp rất nhiều cho người dùng có quyết định lựa chọn đúng đắn."></textarea>
                                        </div>
                                    </div>

                                    <button class="submit-comment">Đánh giá</button>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <aside>
                        <div class="side-bar">
                            <!--recipes search widget-->
                            <div class="widget recipe-search">

                                <div class="category-list">
                                    <!--<div class="list-inner">-->
                                    <ul id="list-category-item-recipe-detail"></ul>
                                    <!--</div>-->
                                </div>
                            </div>
                            <!---recipes search widget ends-->
                            <!--popular recipes widget-->
                            <div class="widget latest-news-widget">
                                <h2>popular recipes</h2>
                                <ul id="popular-recipes-detail"></ul>
                            </div>
                            <!--popular recipes widget ends-->
                            <div class="widget">
                                <a href="#">
                                    <img src="/recipepress/images/temp-images/add-side.jpg" alt="Add" />
                                </a>
                            </div>
                            <!--latest news widget-->
                            <div class="widget latest-news-widget">
                                <h2>Latest Recipes</h2>
                                <ul id="latest-recipe-detail"></ul>
                            </div>
                            <!--latest news widget ends-->
                            <!--get social-->
                            <div class="widget widget-get-social">
                                <h2>get social</h2>
                                <ul>
                                    <li class="facebook">
                                        <a href="#">
                                            <i class="fa fa-facebook"></i>
                                            <span class="count">23.5K</span>
                                            <span class="count-type">Likes</span>
                                        </a>
                                    </li>
                                    <li class="twitter">
                                        <a href="#">
                                            <i class="fa fa-twitter"></i>
                                            <span class="count">23.5K</span>
                                            <span class="count-type">Likes</span>
                                        </a>
                                    </li>
                                    <li class="google-plus">
                                        <a href="#">
                                            <i class="fa fa-google-plus"></i>
                                            <span class="count">23.5K</span>
                                            <span class="count-type">Likes</span>
                                        </a>
                                    </li>

                                </ul>
                            </div>

                            <!--get social ends-->
                        </div>
                    </aside>

                </div>
            </div>

        </div>
        <!-- The Modal -->
        <div id="modal-suggest-ingredients" class="modal">
            <!-- Modal content -->
            <div class="row modal-content">
                <div class="col-md-12 modal-header">
                    <span id="close-modal-suggest" class="close">&times;</span>
                </div>
                <div class="col-md-12 modal-body">
                    <div class="col-md-5">

                        <div class="modal-component-1" id="modal-products">
                            <div class="email-field box-search-ingre">
                                <input onkeyup="filterIngredients()" id="filter-ingredient" type="text" placeholder="Tìm kiếm">
                                <button><i class="fa fa-search"></i></button>
                            </div>
                            <ul id="modal-list-item" class="modal-list-product-item"></ul>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="modal-component-2">
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div id="modal-share-recipe" class="modal">
            <!-- Modal content -->
            <div class="row modal-content modal-share-content">
                <div class="col-md-12 modal-header">
                    <span id="close-share-recipe" class="close">&times;</span>
                </div>
                <div class="col-md-12 modal-body" id="modal-body-share-recipe">
                </div>
            </div>

        </div>
        <div id="modal-add-collection" class="modal">
            <!-- Modal content -->
            <div class="row modal-content modal-share-content">
                <div class="col-md-12 modal-header">
                    <h4 class="title-modal-collection">Thêm vào bộ sưu tập<span id="close-add-collection" class="close">&times;</span></h4>
                </div>
                <div class="col-md-12 modal-body row gutter--15 AdjustRow" id="modal-body-add-collection">
                </div>
            </div>

        </div>
    </div>

@section Scripts {
    <script src="~/js/recipeDetail.js"></script>
    <script type="text/javascript" src="recipepress/js/plugins.min.js"></script>
    <script type="text/javascript" src="recipepress/js/color-switcher.min.js"></script>
    <script type="text/javascript" src="recipepress/js/main.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script type="text/javascript">
        // fetch and render element to html
        const changeHeadername = async () => {
            var someText = "Công thức chi tiết";
            $('.main-heading h1').append(document.createTextNode(someText));
        };
        var map, infoWindow, pos, marker;
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 10.762622, lng: 106.660172 },
                zoom: 15
            });
            infoWindow = new google.maps.InfoWindow;
            marker = new google.maps.Marker;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    marker.setPosition(pos);
                    marker.setMap(map);
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                    infoWindow.setPosition(pos);
                    infoWindow.setContent('Vị trí của bạn');
                    infoWindow.open(map, marker);
                    map.setCenter(pos);
                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        };
        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                'Lỗi: Dịch vụ định vị xảy ra lỗi' :
                'Lỗi: Trình duyệt của bạn không hỗ trợ định vị');
            infoWindow.open(map);
        };
        (async () => {
            // Init elements
            await changeHeadername();
            await callRecipeDetailApi(@(RouteData.Values["recipe_id"]));
            await callStepOfRecipeApi(@(RouteData.Values["recipe_id"]));
            await callChefRecipeApi(@(RouteData.Values["recipe_id"]));
            await callPopularRecipeDetailPageApi();
            await callLatestRecipeDetailApi();

            // Init products on modal list product item
            // Get ingredient names
            //$('input[name=ingredient]').each(async function (index, element) {
            //    // Get name
            //    var value = element.getAttribute("value");
            //    if (value) {
            //        var ingredientName = value.split('-')[1];
            //        await callReadProductByIngredientNameApi(ingredientName);
            //    }
            //});

            callListCategoryItemDetailPage();
            // Recipe slider variation two
            $('.slider-detail2').slick({
                autoplay: true,
                infinite: true,
                pauseOnHover: true,
                prevArrow: $('.left-arrow'),
                nextArrow: $('.right-arrow')
            });
            $('dl.accordion dt').on("click", function () {
                $(this).siblings('dt').removeClass('current');
                $(this).addClass('current').next('dd').stop(true, true).slideDown(500).siblings('dd').stop(true, true).slideUp(500);
            });
        })();

        $("#btn-suggest-ingredients").on("click", function (e) {
            callReadProductByIngredientNameApi();
            $("#modal-suggest-ingredients").css("display", "block")

        });
        $("#close-modal-suggest").on("click", function (e) {
            $("#modal-suggest-ingredients").css("display", "none");

        });
        $("#btn-share-recipe").on("click", function (e) {
            callShareRecipeModalApi(@(RouteData.Values["recipe_id"]));
            $("#modal-share-recipe").css("display", "block")

        });
        $("#close-share-recipe").on("click", function (e) {
            $("#modal-share-recipe").css("display", "none")

        });
        $("#btn-add-collection").on("click", function (e) {
            callReadCollectionModalApi();
             $("#modal-add-collection").css("display", "block")

        });
        $("#close-add-collection").on("click", function (e) {
            $("#modal-add-collection").css("display", "none")

        });
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target.id == "modal-suggest-ingredients") {
                $("#modal-suggest-ingredients").css("display", "none");
            }
            if (event.target.id == "modal-share-recipe") {
                $("#modal-share-recipe").css("display", "none");
            }
            if (event.target.id == "modal-add-collection") {
                $("#modal-add-collection").css("display", "none");
            }
            if (event.target.className == 'modal-product-item') {
                var current = event.target;
                var ingredientName = current.getAttribute('data-product-name');
                callReadNearByStoresApi(pos.lat, pos.lng, ingredientName);
            }
        }

        function filterIngredients() {
            var input, filter, ul, li, a, i, txtValue;
            input = document.getElementById("filter-ingredient");
            filter = input.value.toUpperCase();
            ul = document.getElementById("modal-list-item");
            li = ul.getElementsByTagName("li");
            for (i = 0; i < li.length; i++) {
                a = li[i];
                txtValue = a.textContent || a.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        };
        var star;
        $("input[name='rating']").on("click", function (e) {
            star = parseFloat(e.target.value);

        });
        $(".submit-comment").on("click", function () {
            var comment = $("textarea[name='comment']").val();
            callCreateRatingRecipeApi(@(RouteData.Values["recipe_id"]), star, comment);

        });
        async function toggleLikeButton(x) {
            try {
                var token = JSON.parse(localStorage.getItem('authorization')).token;
                var recipeId = @(RouteData.Values["recipe_id"]);
                var res = await fetch(`https://localhost:44361/api/userreactionrecipe/like?recipeId=${recipeId}`, {
                    method: 'get',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                });
                var data = await res.json();
                if (data.isLike) {
                    x.classList.add("fa-heart");
                }
                else {
                    x.classList.remove("fa-heart");

                }
            } catch (e) {
                alert("Like không thành công")

            }
        }

        callIsLikeRecipe( @(RouteData.Values["recipe_id"]));

        var textarea = document.querySelector('.textarea-caption');
        textarea.addEventListener('keydown', autosize);

        function autosize() {
            var el = this;
            setTimeout(function () {
                el.style.cssText = 'height:auto; padding:0';
                // for box-sizing other than "content-box" use:
                // el.style.cssText = '-moz-box-sizing:content-box';
                el.style.cssText = 'height:' + el.scrollHeight + 'px';
            }, 0);
        }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzgvkqSdA28vGw5qvqgJdPp-3_8YEBzFo&callback=initMap">
    </script>
}
<script type="text/javascript" src="~/recipepress/js/pagination.js"></script>
<script src="~/js/recipe.js"></script>